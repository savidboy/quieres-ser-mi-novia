<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Querida Sheyla ü§ç</title>

  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:ital,wght@0,400;0,700;1,700;1,900&family=Quicksand:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #fff9f7;
      --card: #ffffff;
      --accent: #ff6b81;
      --muted: #7a5a5a;
      --ink: #382f2f;
      --radius: 18px;
      --maxwidth: 1150px;
      --paper: #fffaf6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg, var(--paper) 0%, #fff7f4 60%);
      font-family: 'Quicksand', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--ink);
      padding:22px 18px 42px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      width:100%;
      max-width:var(--maxwidth);
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.995));
      border-radius:22px;
      box-shadow: 0 24px 80px rgba(56,43,43,0.08);
      padding:28px;
      position:relative;
      overflow:visible;
    }

    .wrap::before, .wrap::after{
      content:"";
      position:absolute;
      width:360px;
      height:360px;
      border-radius:50%;
      opacity:0.06;
      pointer-events:none;
      transform-origin:center;
      animation: slow-spin 20s linear infinite;
    }
    .wrap::before{ right:-140px; top:-120px; background: radial-gradient(circle at 30% 30%, #ffdfe6, transparent 40%); transform: rotate(12deg); }
    .wrap::after{ left:-140px; bottom:-120px; background: radial-gradient(circle at 70% 70%, #fff1f3, transparent 40%); transform: rotate(-6deg); }
    @keyframes slow-spin { from{transform:rotate(0);} to{transform:rotate(360deg);} }

    header{text-align:center;margin-bottom:12px}
    .lead{ font-size:15px; color:var(--muted); margin-bottom:6px; font-style:italic; opacity:0.98; }
    h1{ font-family: 'Great Vibes', cursive; font-size:60px; margin:6px 0 0 0; color:#6a333a; line-height:1; text-shadow: 0 2px 6px rgba(106,51,58,0.04); }
    .meta{ color:var(--muted); font-size:13px; margin-top:6px; }

    main{ margin-top:18px; display:grid; grid-template-columns: 1fr 380px; gap:22px; padding-right:8px; align-items:start; }
    .content{ min-width:0; max-height:78vh; overflow:auto; padding-right:12px; scroll-behavior:smooth; }
    .card{ background:var(--card); border-radius:16px; padding:20px; box-shadow: 0 6px 28px rgba(56,43,43,0.05); margin-bottom:16px; line-height:1.6; position:relative; transition:transform .18s ease; }
    .card:hover{ transform: translateY(-4px); }
    h2{ font-family: 'Playfair Display', serif; font-size:20px; margin:0 0 8px 0; color:#5b3336; }
    p{ margin:10px 0; color:var(--ink); font-size:15px; white-space:pre-wrap; }
    .quote{ border-left:4px solid var(--accent); padding-left:12px; margin:12px 0; font-style:italic; color:#5a4042; background: linear-gradient(90deg, rgba(255,107,129,0.03), rgba(255,200,210,0.02)); border-radius:8px; padding:12px; }
    ul{ margin:8px 0 8px 20px; } li{ margin:6px 0; }

    aside{ min-width:0; position:sticky; top:26px; align-self:start; max-height:78vh; overflow:auto; }
    .card.side{ display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center; padding:18px; }
    .avatar{ width:120px; height:120px; border-radius:999px; background:linear-gradient(180deg,#fff,#fff0); display:flex; align-items:center; justify-content:center; font-size:48px; box-shadow:0 10px 30px rgba(106,51,58,0.06); transform:translateY(0); transition:transform .28s cubic-bezier(.2,.9,.3,1); }
    .avatar:hover{ transform:translateY(-6px) rotate(-4deg); }
    .tiny{ color:var(--muted); font-size:13px; line-height:1.4; }
    .hearts{ display:flex; gap:10px; margin-top:8px; } .heart{ width:46px; height:46px; border-radius:12px; display:inline-grid; place-items:center; border:1px solid rgba(106,51,58,0.06); font-size:20px; color:var(--accent); background: linear-gradient(180deg,#fff,#fff6) }

    footer{ margin-top:18px; text-align:center; color:var(--muted); font-size:13px; }
    .signature{ margin-top:8px; font-weight:700; color:#4a2b2d; font-size:15px; }

    @media (max-width:980px){ main{ grid-template-columns: 1fr; } .avatar{ width:96px; height:96px; font-size:40px; } }

    /* Juego */
    .canvas-container { padding: 14px; border-radius: 16px; background: linear-gradient(180deg,#fff,#fff8f8); box-shadow: 0 8px 28px rgba(56,43,43,0.04); }
    canvas#gameCanvas{ width:100%; height:auto; display:block; border-radius:8px; background:linear-gradient(180deg,#fff6f8,#fff0f2); box-shadow:0 8px 20px rgba(0,0,0,0.04); border:1px solid rgba(106,51,58,0.03); }
    .controls{ display:flex; gap:8px; justify-content:center; margin-top:8px; flex-wrap: wrap;}
    .btn{ padding:8px 12px; border-radius:999px; border:1px solid rgba(56,43,43,0.06); background:white; cursor:pointer; font-weight:700; color:#5b3336; transition:transform .12s ease, background .12s ease; }
    .btn:hover{ background:#fff3f5; transform:translateY(-2px); }
    .small{ font-size:13px; color:var(--muted); }

    .title{font-weight:800;color:#5b3336;margin-bottom:6px;text-align:center}
    .ui{display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid rgba(0,0,0,0.06);border-radius:999px;background:#fff;font-weight:700;color:#5b3336}
    .status{margin-top:6px;text-align:center;font-weight:700;color:#5b3336;min-height:20px}
    .message{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#fff;border:1px solid rgba(0,0,0,0.08);border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,0.14);padding:10px 14px;font-weight:800;color:#6a333a;opacity:0;pointer-events:none;transition:opacity .2s ease; z-index: 1001;}
    .message.show{opacity:1;pointer-events:auto}

    #secretModal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(0.98); min-width:300px; max-width:90%; padding:18px; background:linear-gradient(180deg,#fff,#fff9f7); border-radius:14px; box-shadow:0 30px 80px rgba(0,0,0,0.25); opacity:0; pointer-events:none; transition:transform .22s cubic-bezier(.2,.9,.3,1), opacity .22s ease; z-index:1000; text-align:center; }
    #secretModal.visible{ transform:translate(-50%,-50%) scale(1); opacity:1; pointer-events:auto; }
    #secretModal h3{ margin:6px 0 10px 0; font-family:'Great Vibes',cursive; font-size:28px; color:#6a333a;}
    
    /* --- CAMBIO 1: A√ëADIDO 'white-space: pre-wrap' --- */
    #secretModal p{ margin:8px 0; font-weight:700; color:#5b3336; white-space: pre-wrap; }
    
    #secretModal button{ margin-top:10px; padding:8px 12px; border-radius:999px; border:1px solid rgba(56,43,43,0.06); background:white; cursor:pointer; font-weight:700; }

    #secretOverlay{ position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.14)); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:999; }
    #secretOverlay.visible{ opacity:1; pointer-events:auto; }

    .page-secret { position: absolute; background: transparent; border: none; font-size:20px; cursor:pointer; transform: translate(-50%,-50%); opacity:0.95; transition: transform .22s ease, filter .22s ease, opacity .2s; }
    .page-secret:hover { transform: translate(-50%,-50%) scale(1.18); filter: drop-shadow(0 6px 18px rgba(255,107,129,0.22)); }
    .page-secret:focus{ outline:2px solid rgba(255,107,129,0.25); border-radius:12px; }

    .signature-card{
      border-radius:14px;
      padding:14px;
      background: linear-gradient(180deg, rgba(255,245,246,0.75), rgba(255,250,250,0.6));
      border:1px solid rgba(255,107,129,0.06);
      box-shadow: 0 10px 30px rgba(106,51,58,0.03);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }
    .sig-left{ display:flex; gap:12px; align-items:center; }
    .sig-avatar{ width:64px; height:64px; border-radius:12px; background:linear-gradient(180deg,#fff,#ffecec); display:grid; place-items:center; font-size:30px; color:#9b3b43; box-shadow:0 6px 18px rgba(106,51,58,0.04); transform:translateY(0); transition:transform .18s ease; }
    .sig-avatar:hover{ transform:translateY(-6px); }
    .sig-text{ text-align:left; }
    .sig-title{ font-weight:800; color:#5b3336; font-size:15px; }
    .sig-sub{ font-size:12px; color:var(--muted); }

    .flair { display:inline-block; padding:6px 10px; background: linear-gradient(90deg,#fff8, #fff2); border-radius:999px; border:1px solid rgba(255,107,129,0.06); font-size:13px; color:#8a383f; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap" role="article" aria-label="Carta para Sheyla">
    <header>
      <div class="lead">Todo lo que siento por ti, guardadito para que lo recuerdes ü§ç</div>
      <h1>Querida Sheyla ü§ç</h1>
      <div class="meta">01/16/2025</div>
    </header>

    <main>
      <section class="content" id="content">
        <article class="card" id="page-1" aria-labelledby="intro-title">
          <h2 id="intro-title">Introducci√≥n ‚Äî esto es todo lo que guard√©</h2>
          <p>Desde el d√≠a en que te conoc√≠ (ese 16 de enero que ahora parece una fecha con magia), guard√© en mi cabeza y en peque√±as notas todo lo que sent√≠a. Esto no es algo improvisado: es un pedazo de mi tiempo, pensado para ti, para que lo lees cuando quieras y recuerdes c√≥mo me pongo cuando pienso en ti.</p>
          <p>No es un texto perfecto ni una carta de novela; es mi voz con errores, con risas raras (JSAKJSKAJKSA) y con la verdad al desnudo. Si alguna frase suena torpe, es porque es sincera. Si alguna suena intensa, es porque as√≠ me sent√≠. Y si algo te hace sonrojar, es parte del plan. ü§ç</p>
          <button class="page-secret" data-secret="Eres mi mejor casualidad ü§ç" style="left:88%; top:22%;">ü§ç</button>
        </article>

        <article class="card" id="page-2" aria-labelledby="primera-title">
          <h2 id="primera-title">La primera vez que te vi</h2>
          <p>Recuerdo ese momento como si fuera una foto medio borrosa pero con el color m√°s fuerte: te vi con curiosidad en la mirada, preguntando cosas, y esa forma tuya de interesarte me atrap√≥. No hab√≠a planes, solo una sensaci√≥n rara en el pecho que ahora entiendo mejor. ü§ç</p>
          <button class="page-secret" data-secret="Mi coraz√≥n supo tu nombre desde ese d√≠a ‚ú®" style="left:82%; top:66%;">ü§ç</button>
        </article>

        <article class="card" id="page-3" aria-labelledby="equivoco-title">
          <h2 id="equivoco-title">En qu√© me equivoqu√© (y por qu√© me r√≠o de eso)</h2>
          <p>Hubo muchas cosas que pens√© mal al principio. Cre√≠ que ser√≠a otra cosa pasajera, que quiz√° solo ser√≠as una amiga m√°s. Me dio miedo confesar lo que sent√≠a por miedo a perder lo que ya ten√≠amos; as√≠ que me escond√≠ detr√°s de bromas, mensajes y silencios.</p>
          <button class="page-secret" data-secret="Me equivoqu√© de miedo, no de amor." style="left:18%; top:30%;">ü§ç</button>
        </article>

        <article class="card" id="page-4" aria-labelledby="valoro-title">
          <h2 id="valoro-title">Lo que m√°s valoro de nosotros</h2>
          <p>Valoro la sinceridad, esa que no necesita adornos. Valoro cuando me miras con esa calma que parece decir ‚Äútodo va a estar bien‚Äù. Valoro que no dejemos que una pelea sea el final, sino la oportunidad de entendernos mejor. ü§ç</p>
          <button class="page-secret" data-secret="Tu calma me salva. Tu risa me encuentra." style="left:14%; top:24%;">ü§ç</button>
        </article>

        <article class="card" id="page-5" aria-labelledby="siento-title">
          <h2 id="siento-title">Lo que siento contigo</h2>
          <p>Lo que siento es casi imposible de explicar sin sonar dram√°tico: ganas de cuidarte, de protegerte, pero tambi√©n de compartir momentos chiquitos que, al final, son los que m√°s cuentan. No quiero que suene intenso porque s√≠; es que realmente me importa todo lo que te pasa.</p>
          <div class="quote">Eres mi mejor elecci√≥n. Y lo dir√© as√≠, simple y claro.</div>
          <button class="page-secret" data-secret="Elegirte es mi decisi√≥n favorita." style="left:72%; top:36%;">ü§ç</button>
        </article>

        <article class="card" id="page-6" aria-labelledby="futuro-title">
          <h2 id="futuro-title">Nuestro futuro (lo que imagino)</h2>
          <p>Cuando imagino el futuro, no veo castillos ni grandes promesas de pel√≠cula; imagino rutinas contigo: desayunos desordenados, d√≠as donde trabajamos y nos contamos el error del d√≠a, y noches donde re√≠mos hasta quedarnos dormidos. Eso para m√≠ ya es mucho. ü§ç</p>
          <button class="page-secret" data-secret="Nuestro futuro sabe a caf√© y domingos juntos ‚òïü§ç" style="left:50%; top:18%;">ü§ç</button>
        </article>

        <article class="card" id="page-7" aria-labelledby="promesas-title">
          <h2 id="promesas-title">Promesas (promesas con intenci√≥n)</h2>
          <ul>
            <li>Prometo cuidarte y pedir ayuda cuando no alcance mi fuerza.</li>
            <li>Prometo preocuparme por tu salud y tu paz m√°s que por mi orgullo.</li>
            <li>Prometo ser leal: en acciones peque√±as y grandes.</li>
            <li>Prometo aprender a comunicarme mejor, a decir cuando me siento mal en vez de cerrarme.</li>
            <li>Prometo intentarlo siempre, aunque falle, porque mi intenci√≥n ser√° regresar y corregir.</li>
          </ul>
          <button class="page-secret" data-secret="Prometerte es cuidarte en lo peque√±o." style="left:22%; top:64%;">ü§ç</button>
        </article>

        <article class="card" id="page-8" aria-labelledby="gracias-title">
          <h2 id="gracias-title">Gracias por‚Ä¶</h2>
          <p>Gracias por elegir quedarte, incluso en momentos donde no me cuid√©. Gracias por no alejarte al conocer mi pasado; gracias por darme la oportunidad de ser alguien distinto junto a ti. ü§ç</p>
          <button class="page-secret" data-secret="Gracias por quedarte incluso cuando yo no sab√≠a c√≥mo." style="left:84%; top:42%;">ü§ç</button>
        </article>

        <article class="card" id="page-9" aria-labelledby="cancion-title">
          <h2 id="cancion-title">Nuestra canci√≥n + Jueguito</h2>
          <p>Hay una melod√≠a que, sin decir mucho, siempre me trae a ti. No hablo de versos ni de frases; hablo de esa sensaci√≥n que me da escuchar algo y sentir que te tengo un poquito m√°s cerca.</p>

          <div class="quote" style="text-align:center;">
              <a href="https://music.youtube.com/watch?v=sUZOuXo2Bp8&si=jnc7BJ2nh2Sy32l2" target="_blank" style="text-decoration:none; color:#ff6b81; font-weight:bold;">
                  ‚ñ∂ Escuchar (la canci√≥n que siempre me recuerda a ti) ü§ç
              </a>
          </div>

          <div class="player-wrap" aria-label="Reproductor de nuestra canci√≥n" style="margin-top:6px">
            <div class="player-title">Nuestra canci√≥n (presiona Play)</div>
            <audio id="loveSong" controls>
              <source src="/As√≠%20Te%20Ped√≠%20-%20Zeri.mp3" type="audio/mpeg">
              Tu navegador no soporta audio.
            </audio>
            <div class="tiny" style="text-align:center; margin-top:6px;">Presiona Play para escucharla. Si el nombre con acentos da problemas, ren√≥mbrala a /asi-te-pedi-zeri.mp3 y cambia esta ruta.</div>
          </div>

          <div style="width:100%; margin-top:18px;">
            <div class="canvas-container" aria-label="√Årea de juego y controles">
              <div class="title">Shey Level Devil ‚Äî 14 niveles TROLL ü§ç</div>

              <canvas id="gameCanvas" width="900" height="480" tabindex="0" aria-label="Mini juego para Sheyla"></canvas>

              <div class="ui">
                <div class="badge">Nivel: <span id="levelLabel">1</span></div>
                <div class="badge">Intentos: <span id="triesLabel">0</span></div>
                <div class="badge">Power-up: <span id="powerLabel">‚ùå Sin doble salto</span></div>
              </div>

              <div class="controls" style="margin-top:8px">
                <button id="restartBtn" class="btn">Reiniciar</button>
                <button id="nextBtn" class="btn">Siguiente nivel</button>
              </div>

              <div id="status" class="status">Nivel 1 ‚Äî calentando, suave como caf√© con pan ü§ç</div>
            </div>
          </div>

          <button class="page-secret" data-secret="Dale Play y qu√©date conmigo un ratito." style="left:10%; top:20%;">ü§ç</button>
        </article>

        <article class="card" id="page-10" aria-labelledby="significas-title">
          <h2 id="significas-title">Lo mucho que significas para m√≠</h2>
          <p>Princesa, eres todo para m√≠. Esta parte de la p√°gina es para recordarte cada que vengas y lo leas, adem√°s de lo que tanto te lo recuerdo cuando vamos a dormir o cuando me dan ataques de amor.</p>
          <button class="page-secret" data-secret="Mi lugar favorito siempre ser√° a tu lado." style="left:74%; top:40%;">ü§ç</button>
        </article>

        <article class="card" id="page-11" aria-labelledby="pdf-title">
          <h2 id="pdf-title">Aqu√≠ hay otra cosita para ti ‚ú®</h2>
          <p>Mi princesa, no todo lo que siento pod√≠a caber en esta p√°gina. Por eso, he guardado un documento especial solo para ti, lleno de m√°s cosas que quiero recordarte.</p>
          <div class="quote" style="text-align:center;">
              <a href="https://drive.google.com/file/d/1RHUHGqlFmizHURG8fprh7Ev59fcAruEW/view?usp=sharing" target="_blank" style="text-decoration:none; color:#ff6b81; font-weight:bold;">
                  üìÑ Abrir el documento secreto (PDF) ü§´
              </a>
          </div>
          <p class="tiny" style="text-align:center; margin-top:10px;">(¬°Ya est√° el enlace! Entra cuando quieras, mi ni√±a. Te amo. üíñ)</p>
          <button class="page-secret" data-secret="Lo que no te digo en voz alta, tambi√©n te lo guardo." style="left:68%; top:24%;">ü§ç</button>
        </article>

        <article class="card" id="page-12" aria-labelledby="final-title">
          <h2 id="final-title">El Final, sellado con mi Coraz√≥n ü§ç</h2>
          <p>Esto no es un cierre, es el inicio de todo lo que quiero construir contigo. Es una caja de palabras que guard√© con el m√°s puro y blanco de mis cari√±os. Gu√°rdala, impr√≠mela, l√©ela, pero sobre todo, recuerda que cada l√≠nea tiene un pedacito de mi alma, entregado solo para ti.</p>
          <p>Mi vida, mi ni√±a, <strong>TE AMO con toda la fuerza y la sinceridad de mi coraz√≥n. Eres mi todo, hoy y siempre.</strong></p>

          <div class="signature-card" style="margin-top:12px">
            <div class="sig-left">
              <div class="sig-avatar">S</div>
              <div class="sig-text">
                <div class="sig-title">Con todo mi coraz√≥n ‚Äî Samuel ü§ç</div>
                <div class="sig-sub">01/16/2025 ¬∑ Guardado para ti</div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="flair">Hecho con paciencia y amor</div>
            </div>
          </div>

          <button class="page-secret" data-secret="Hoy y siempre, contigo. ü§ç" style="left:92%; top:18%;">ü§ç</button>
        </article>

        <article class="card" id="page-13" aria-labelledby="extra13-title">
          <h2 id="extra13-title">Un recuerdo m√°s</h2>
          <p>Aqu√≠ otro pedacito peque√±o de lo que somos: un lugar, una risa, una canci√≥n que suena a nosotros. ü§ç</p>
          <button class="page-secret" data-secret="Tu nombre le queda perfecto a mis planes." style="left:60%; top:30%;">ü§ç</button>
        </article>

        <article class="card" id="page-14" aria-labelledby="extra14-title">
          <h2 id="extra14-title">Cierre √≠ntimo</h2>
          <p>Si llegaste hasta aqu√≠, gracias. Todo esto es para ti, para recordarte que te elijo siempre.</p>
          <button class="page-secret" data-secret="Te elijo en el amanecer y tambi√©n en el cansancio." style="left:26%; top:70%;">ü§ç</button>
        </article>

      </section>

      <aside>
        <div class="card side" aria-labelledby="sidebar-title">
          <div id="sidebar-title" style="font-weight:800;color:#5b3336">Un resumen bonito</div>
          <div class="avatar" aria-hidden="true">ü§ç</div>
          <div class="tiny">Guardado con cuidado desde 01/16/2025 ‚Äî un texto hecho para ti, con risas, promesas y muchas ganas de verte.</div>
          <div class="hearts" aria-hidden="true"><div class="heart">‚ô•</div><div class="heart">‚ù£</div><div class="heart">üí´</div></div>

          <div class="signature-card" style="margin-top:10px; width:100%;">
            <div class="sig-left">
              <div class="sig-avatar">S</div>
              <div class="sig-text">
                <div class="sig-title">Con todo mi coraz√≥n, Samuel ü§ç</div>
                <div class="sig-sub">01/16/2025 ¬∑ Guardado para ti</div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:10px; padding:12px; box-shadow:none; border:none;">
            <div class="tiny">Si quieres, personalizo frases de cada secreto con recuerdos puntuales (lugar, canci√≥n, frase).</div>
          </div>
        </div>

        <div class="card side" aria-labelledby="nota-title">
          <div id="nota-title" style="font-weight:700;color:#5b3336">Nota r√°pida</div>
          <p class="tiny">Esto fue escrito y guardado con empe√±o para ti. Si te emociona, h√°zmelo saber; si quieres que lo ajuste, lo har√©.</p>
        </div>
      </aside>
    </main>

    <footer>
      <div style="font-size:13px;color:#7a5a5a">Hecho con cari√±o ¬∑ C√≥pialo, impr√≠melo o gu√°rdalo como quieras.</div>
    </footer>
  </div>

  <div id="secretOverlay" aria-hidden="true"></div>
  <div id="secretModal" aria-hidden="true" role="dialog" aria-modal="true">
    <h3>Secreto</h3>
    <p id="secretText">my princess ü§ç i love u</p>
    <button id="closeSecretBtn">Cerrar</button>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    /* ---------- AUDIO FX (suave) ---------- */
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch (e) { audioCtx = null; }
      }
    }
    function resumeAudioIfNeeded() {
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    }
    document.addEventListener('click', ()=> { ensureAudio(); resumeAudioIfNeeded(); }, { once: true });

    function playTone(freq, type='sine', duration=0.12, gain=0.12, when=0, detune=0) {
      if (!audioCtx) { ensureAudio(); if(!audioCtx) return; }
      const t = audioCtx.currentTime + when;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.setValueAtTime(freq, t); o.detune.value = detune;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + duration);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t); o.stop(t + duration + 0.02);
    }

    const sfx = {
      jump(){ playTone(420,'sine',0.08,0.12); },
      double(){ playTone(520,'triangle',0.12,0.14); playTone(660,'sine',0.09,0.08,0.05); },
      power(){ playTone(880,'sine',0.18,0.15); playTone(1320,'triangle',0.12,0.08,0.06); },
      hit(){ playTone(180,'sawtooth',0.14,0.18); },
      ok(){ playTone(620,'sine',0.12,0.14); playTone(780,'sine',0.12,0.12,0.06); playTone(980,'triangle',0.18,0.08,0.12); },
      modal(){ playTone(720,'sine',0.14,0.16); playTone(940,'sine',0.12,0.08,0.06); },
      secret(){ playTone(1020,'triangle',0.12,0.14); }
    };

    /* ---------- SECRETOS ---------- */
    const pageSecrets = Array.from(document.querySelectorAll('.page-secret'));
    const secretModal = document.getElementById('secretModal');
    const secretOverlay = document.getElementById('secretOverlay');
    const secretTextEl = document.getElementById('secretText');
    const closeSecretBtn = document.getElementById('closeSecretBtn');

    function showSecret(text){
      secretTextEl.textContent = text;
      secretModal.classList.add('visible');
      secretOverlay.classList.add('visible');
      sfx.modal();
      closeSecretBtn.focus();
    }
    function hideSecret(){
      secretModal.classList.remove('visible');
      secretOverlay.classList.remove('visible');
    }

    pageSecrets.forEach(btn=>{
      btn.setAttribute('aria-label','Secreto rom√°ntico');
      btn.addEventListener('click', ()=>{
        const t = btn.dataset.secret || 'my princess ü§ç i love u';
        sfx.secret();
        showSecret(t);
      });
      btn.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btn.click(); }
      });
    });

    closeSecretBtn.addEventListener('click', hideSecret);
    secretOverlay.addEventListener('click', hideSecret);
    document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') hideSecret(); });

    /* ---------- JUEGO INTEGRADO (14 niveles, balanceado) ---------- */
    (function(){
      const canvas = document.getElementById('gameCanvas');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;

      const levelLabel = document.getElementById('levelLabel');
      const triesLabel = document.getElementById('triesLabel');
      const powerLabel = document.getElementById('powerLabel');
      const statusEl = document.getElementById('status');

      // Mensajes flash
      const flashEl = document.createElement('div');
      flashEl.id = 'msg';
      flashEl.className = 'message';
      document.body.appendChild(flashEl);
      function flashMessage(text, time=1800){
        flashEl.textContent = text;
        flashEl.classList.add('show');
        setTimeout(()=> flashEl.classList.remove('show'), time);
      }

      const mensajes = [
        "Desde el d√≠a en que te conoc√≠, todo cambi√≥ ü§ç", // Nivel 1
        "Mi coraz√≥n supo tu nombre desde ese d√≠a ‚ú®", // Nivel 2
        "Me equivoqu√© de miedo, no de amor.", // Nivel 3
        "Tu calma me salva. Tu risa me encuentra.", // Nivel 4
        "Elegirte es mi decisi√≥n favorita.", // Nivel 5
        "Nuestro futuro sabe a caf√© y domingos juntos ‚òïü§ç", // Nivel 6
        "Prometerte es cuidarte en lo peque√±o.", // Nivel 7
        "Gracias por quedarte incluso cuando yo no sab√≠a c√≥mo.", // Nivel 8
        "Dale Play y qu√©date conmigo un ratito.", // Nivel 9
        "Mi lugar favorito siempre ser√° a tu lado.", // Nivel 10
        "Lo que no te digo en voz alta, tambi√©n te lo guardo.", // Nivel 11
        "Hoy y siempre, contigo. ü§ç", // Nivel 12
        "Tu nombre le queda perfecto a mis planes.", // Nivel 13
        "Te elijo en el amanecer y tambi√©n en el cansancio." // Nivel 14
      ];

      // Input
      const keys = {left:false,right:false,jump:false};
      canvas.addEventListener('keydown', (e)=>{
        const k = e.key;
        if(['ArrowLeft','ArrowRight','ArrowUp',' '].includes(k)) e.preventDefault();
        if(k==='ArrowLeft') keys.left=true;
        if(k==='ArrowRight') keys.right=true;
        if(k==='ArrowUp' || k===' ') keys.jump=true;
      });
      canvas.addEventListener('keyup', (e)=>{
        const k = e.key;
        if(k==='ArrowLeft') keys.left=false;
        if(k==='ArrowRight') keys.right=false;
        if(k==='ArrowUp' || k===' ') keys.jump=false;
      });
      canvas.addEventListener('click', ()=> { canvas.focus(); });

      // Player con calidad de vida (coyote + buffer)
      const playerBase = {
        x:48,y:H-120,w:32,h:40,
        vx:0,vy:0,
        onGround:false,
        hasDouble:false,hasJumpedOnce:false,
        alive:true,
        coyoteTime:0,
        jumpBuffer:0
      };
      const COYOTE_MAX = 0.12;    // 120 ms
      const JUMP_BUFFER_MAX = 0.12;// 120 ms
      const GRAV = 0.58;
      const JUMP_V = -12.0;       // ajustado
      const DOUBLE_V = -10.8;     // ajustado
      const MAX_VX = 4.0;
      const ACCEL = 0.9;
      const FRICTION_GROUND = 0.85;
      const FRICTION_AIR = 0.93;

      let player = {...playerBase};
      let currentLevel = 0;
      let tries = 0;
      let levelTries = {}; // Contador de muertes por nivel

      // Sistema de Part√≠culas
      let particles = [];
      const PARTICLE_GRAV = 0.1;
      
      function emitParticles(x, y, count, color) {
        for (let i = 0; i < count; i++) {
          particles.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 6,
            vy: (Math.random() - 0.5) * 6 - 3,
            life: Math.random() * 30 + 30, // 0.5 a 1 segundo
            color: color
          });
        }
      }
      // Efecto "Ash" (Ceniza) al morir
      function emitAsh(x, y) {
        emitParticles(x + player.w / 2, y + player.h / 2, 20, '#aaaaaa');
      }
      
      function updateParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.vy += PARTICLE_GRAV;
          p.x += p.vx;
          p.y += p.vy;
          p.life--;
          if (p.life <= 0) {
            particles.splice(i, 1);
          }
        }
      }
      function drawParticles() {
        for (const p of particles) {
          ctx.fillStyle = p.color;
          ctx.globalAlpha = p.life / 60; // Desvanecer
          ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
          ctx.globalAlpha = 1.0;
        }
      }
      // Fin Sistema de Part√≠culas

      function rr(x,y,w,h,r=6,fill='#fff',stroke='#e6d4d6'){
        ctx.beginPath(); ctx.moveTo(x+r,y);
        ctx.arcTo(x+w,y,x+w,y+h,r);
        ctx.arcTo(x+w,y+h,x,y+h,r);
        ctx.arcTo(x,y+h,x,y,r);
        ctx.arcTo(x,y,x+w,y,r);
        ctx.closePath(); ctx.fillStyle=fill; ctx.fill(); ctx.strokeStyle=stroke; ctx.stroke();
      }
      function drawSpike(x,y,w=20,h=16){
        ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+w/2,y-h); ctx.lineTo(x+w,y); ctx.closePath();
        ctx.fillStyle = '#c33'; ctx.fill();
      }
      function drawHeart(x,y,r=12){
        ctx.save(); ctx.translate(x,y); ctx.fillStyle='#ff6b81';
        ctx.beginPath();
        ctx.moveTo(0, r/2);
        ctx.bezierCurveTo(r, -r/2, r*1.4, r/1.6, 0, r*1.4);
        ctx.bezierCurveTo(-r*1.4, r/1.6, -r, -r/2, 0, r/2);
        ctx.fill(); ctx.restore();
      }
      function drawStar(x,y,r=10){
        ctx.save(); ctx.translate(x,y); ctx.fillStyle='#ffd86b';
        ctx.beginPath();
        for(let i=0;i<5;i++){
          const a = i*2*Math.PI/5 - Math.PI/2;
          ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
          const a2 = a + Math.PI/5;
          ctx.lineTo(Math.cos(a2)*r*0.5, Math.sin(a2)*r*0.5);
        }
        ctx.closePath(); ctx.fill(); ctx.restore();
      }

      const L = H; // base
      function baseFloor(){ return [{x:0,y:L-20,w:W,h:20}]; }

      // --- DEFINICI√ìN DE NIVELES (ACTUALIZADA con Nivel 14) ---
      const levels = [
        // Nivel 1 (index 0) - TROLL PISO RESBALOSO
        { type:'platform', bg:'warm',
          platforms: baseFloor().concat([{x:200,y:L-120,w:140,h:16}]),
          spikes: [],
          goal: {x:820,y:L-40},
          msg: 'Nivel 1 ‚Äî ¬°Wii, el piso resbala! ü§ç',
          powerup: null
        },
        // Nivel 2 (index 1) - TROLL ESTRELLA FALSA
        { type:'platform', bg:'warm',
          platforms: baseFloor().concat([{x:320,y:L-100,w:140,h:16}]),
          spikes: [
            {x:520,y:L-20,w:80, isFloor:true}, // Pincho de suelo
            {x:380,y:L-100,w:20,h:16, isStarTroll:true} // ¬°Estrella Troll!
          ],
          goal: {x:820,y:L-40},
          msg: 'Nivel 2 ‚Äî ¬°No conf√≠es en todo lo que brilla!',
          powerup: null
        },
        // Nivel 3 (index 2) - ARREGLADO (Escalera posible)
        { type:'platform', bg:'soft',
          platforms: baseFloor().concat([
            {x:220,y:L-120,w:120,h:16}, // Plataforma 1
            {x:450,y:L-170,w:120,h:16}, // Plataforma 2 (50px jump)
            {x:680,y:L-220,w:120,h:16}  // Plataforma 3 (50px jump)
          ]),
          spikes: [{x:430,y:L-20,w:100, isFloor:true}],
          goal: {x:740,y:L-260}, // Meta en el √∫ltimo escal√≥n
          msg: 'Nivel 3 ‚Äî escalones de paciencia (¬°Ahora s√≠!).',
          powerup: null
        },
        // Nivel 4 (index 3) - TROLL PLATAFORMAS (Tu idea)
        { type:'platform', bg:'soft',
          platforms: baseFloor().concat([
            {x:200,y:L-140,w:120,h:16, fake:true}, // P1: Falsa (con punto)
            {x:400,y:L-140,w:120,h:16} // P2: Real
          ]),
          spikes: [{x:150,y:L-20,w:420, isFloor:true}], // Pinchos m√°s grandes
          goal: {x:440,y:L-180},
          msg: 'Nivel 4 ‚Äî Una es real, la otra no. Elige con cuidado.',
          powerup: null
        },
        // Nivel 5 (index 4) - Est√°ndar
        { type:'platform', bg:'warm',
          platforms: baseFloor(),
          moving: [{x:600,y:L-160,w:120,h:16,axis:'y',from:L-220,to:L-120,spd:0.8}],
          spikes: [{x:320,y:L-20,w:80, isFloor:true}],
          goal: {x:650,y:L-200},
          msg: 'Nivel 5 ‚Äî ritmo y calma.',
          powerup: null
        },
        // Nivel 6 (index 5) - ARREGLADO (Plataforma coraz√≥n + Plataforma invisible)
        { type:'platform', bg:'soft',
          platforms: baseFloor().concat([
            {x:200,y:L-140,w:120,h:16}, // P1: (Coraz√≥n) - Ahora alcanzable
            {x:380,y:L-180,w:40,h:16, invisible:true}, // P2: Invisible (sin punto, casi invisible)
            {x:550,y:L-240,w:120,h:16} // P3: Meta (Requiere doble salto)
          ]),
          spikes: [],
          powerup: {x:220,y:L-170, active:true}, // Coraz√≥n (posici√≥n ajustada)
          goal: {x:590,y:L-280}, // Meta
          msg: 'Nivel 6 ‚Äî Salta al vac√≠o... conf√≠a ü§ç'
        },
        // Nivel 7 (index 6) - TROLL CONTROLES INVERTIDOS
        { type:'platform', bg:'warm',
          platforms: baseFloor().concat([{x:520,y:L-160,w:120,h:16}]),
          spikes: [{x:120,y:L-20,w:40, isFloor:true},{x:180,y:L-20,w:40, isFloor:true},{x:240,y:L-20,w:40, isFloor:true}],
          goal: {x:560,y:L-200},
          msg: 'Nivel 7 ‚Äî ¬°Uy! ¬øQu√© le pas√≥ a los controles?',
          powerup: null,
          reversed: true // ¬°Troll activado!
        },
        // Nivel 8 (index 7) - TROLL META OCULTA + MEC√ÅNICA DE PIEDAD
        { type:'platform', bg:'soft',
          platforms: baseFloor().concat([{x:260,y:L-240,w:110,h:16}]), // Plataforma (Altura Dif√≠cil)
          spikes: [{x:420,y:L-20,w:60, isFloor:true},{x:500,y:L-20,w:60, isFloor:true}],
          goal: {x:300,y:L-280, hidden:true}, // Meta (Altura Dif√≠cil)
          msg: 'Nivel 8 ‚Äî gracias por quedarte... (¬øD√≥nde est√° la meta?)',
          powerup: null
        },
        // Nivel 9 (index 8) - TROLL (Plataforma Invisible)
        { type:'platform', bg:'warm',
          platforms: baseFloor().concat([
            {x:450,y:L-220,w:40,h:16, invisible:true}, // Plataforma invisible (requiere Doble Salto)
            {x:620,y:L-280,w:120,h:16} // Plataforma final
          ]),
          spikes: [{x:220,y:L-20,w:40, isFloor:true},{x:280,y:L-20,w:40, isFloor:true},{x:340,y:L-20,w:40, isFloor:true}],
          goal: {x:660,y:L-320},
          msg: 'Nivel 9 ‚Äî (Necesitar√°s un doble salto de fe...)', // Nueva Pista
          powerup: null
        },
        // Nivel 10 (index 9) - Est√°ndar (Puzzle)
        { type:'puzzle-switch', bg:'soft',
          platforms: baseFloor().concat([{x:140,y:L-200,w:120,h:16},{x:380,y:L-240,w:120,h:16}]),
          switches: [{x:160,y:L-216,w:20,h:20,active:false}],
          doors: [{x:520,y:L-20,w:60,h:180,closed:true}], // Puerta en el suelo
          spikes: [{x:480,y:L-20,w:80, isFloor:true}],
          goal: {x:660,y:L-40},
          msg: 'Nivel 10 ‚Äî abre la puerta y ven conmigo.',
          powerup: null
        },
        // Nivel 11 (index 10) - Est√°ndar
        { type:'platform', bg:'sunset',
          platforms: baseFloor(),
          moving: [
            {x:220,y:L-200,w:100,h:16,axis:'x',from:160,to:300,spd:1.0},
            {x:480,y:L-260,w:100,h:16,axis:'y',from:L-300,to:L-200,spd:0.9}
          ],
          spikes: [{x:200,y:L-20,w:60, isFloor:true},{x:620,y:L-20,w:60, isFloor:true}],
          goal: {x:500,y:L-300},
          msg: 'Nivel 11 ‚Äî calma y precisi√≥n.',
          powerup: null
        },
        // Nivel 12 (index 11) - TROLL SECUENCIA
        { type:'puzzle-seq', bg:'soft',
          platforms: baseFloor(),
          pads: [
            {x:160,y:L-80,w:60,h:14,color:'#6fb3ff',order:0},
            {x:320,y:L-80,w:60,h:14,color:'#b88bff',order:1},
            {x:480,y:L-80,w:60,h:14,color:'#7be7c7',order:2}
          ],
          seq: [0,1,2],
          spikes: [{x:260,y:L-20,w:100, isFloor:true}],
          goal: {x:640,y:L-140},
          msg: 'Nivel 12 ‚Äî orden y cari√±o (¬°Cuidado con la secuencia!).',
          powerup: null
        },
        // Nivel 13 (index 12) - Est√°ndar
        { type:'platform', bg:'warm',
          platforms: baseFloor().concat([{x:500,y:L-220,w:120,h:16}]),
          spikes: [{x:150,y:L-20,w:60, isFloor:true},{x:230,y:L-20,w:60, isFloor:true}],
          goal: {x:560,y:L-260},
          msg: 'Nivel 13 ‚Äî tu nombre le queda perfecto a mis planes.',
          powerup: null
        },
        // Nivel 14 (index 13) - TROLL DISTRACCI√ìN
        { type:'platform', bg:'sunset',
          platforms: baseFloor().concat([{x:300,y:L-260,w:120,h:16}]),
          spikes: [{x:420,y:L-20,w:80, isFloor:true}],
          goal: {x:340,y:L-300, distraction:true}, // Star is a distraction, MUST NOT trigger win
          exitWin: true, // Win by reaching the end (right side)
          msg: 'Nivel 14 ‚Äî No busques la estrella, ve hasta el final. ü§ç', // Nueva pista
          powerup: null
        }
      ];

      let puzzle = {switches:[],doors:[],pads:[],seq:[],seqIndex:0};

      function resetPlayer(withPower=false){
        player = {...playerBase};
        player.x = 48; player.y = H-120;
        player.hasDouble = withPower;
        player.hasJumpedOnce = false;
        player.alive = true;
        player.coyoteTime = 0;
        player.jumpBuffer = 0;
      }

      function loadLevel(i){
        const lv = levels[i];
        currentLevel = i;
        
        // Mec√°nica de Piedad Nivel 8
        if (!levelTries[i]) levelTries[i] = 0; // Inicializar contador de muertes del nivel

        if (i === 7) { // Nivel 8
          const plat = lv.platforms.find(p => p.x === 260);
          const goal = lv.goal;
          
          if (levelTries[i] >= 3 && plat) {
            // Si ha muerto 3+ veces, aplicar piedad
            plat.y = L - 220; // Bajarla 20px (de L-240 a L-220)
            goal.y = L - 260; // Bajar meta 20px (de L-280 a L-260)
            lv.msg = 'Nivel 8 ‚Äî (Te baj√© la plataforma un poquito ü§ç)';
          } else {
            // Asegurarse de que est√© en la altura DIF√çCIL original
            if (plat) plat.y = L - 240; 
            if (goal) goal.y = L - 280;
            // Mensaje original
            if (lv.goal.hidden) {
              lv.msg = 'Nivel 8 ‚Äî gracias por quedarte... (¬øD√≥nde est√° la meta?)';
            } else {
              lv.msg = 'Nivel 8 ‚Äî (¬°Necesitas el doble salto!)';
            }
          }
        }
        // Fin Mec√°nica de Piedad

        levelLabel.textContent = i+1;
        statusEl.textContent = lv.msg || `Nivel ${i+1}`;
        powerLabel.textContent = player.hasDouble ? '‚úÖ Doble salto' : '‚ùå Sin doble salto';

        puzzle = {switches:[],doors:[],pads:[],seq:lv.seq||[],seqIndex:0};
        if(lv.switches) puzzle.switches = lv.switches.map(s=>({...s}));
        if(lv.doors) puzzle.doors = lv.doors.map(d=>({...d}));
        if(lv.pads) puzzle.pads = lv.pads.map(p=>({...p,activated:false}));

        resetPlayer(player.hasDouble);
      }

      function drawBG(lv){
        if(lv.bg==='sunset'){
          const g = ctx.createLinearGradient(0,0,0,H);
          g.addColorStop(0,'#ffd6c9'); g.addColorStop(1,'#fff8f6');
          ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
          ctx.beginPath(); ctx.fillStyle = 'rgba(255,200,160,0.18)'; ctx.arc(W-120,80,64,0,Math.PI*2); ctx.fill();
        } else if (lv.bg==='soft'){
          const g = ctx.createLinearGradient(0,0,0,H);
          g.addColorStop(0,'#f8fbff'); g.addColorStop(1,'#fef8fb');
          ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
        } else {
          const g = ctx.createLinearGradient(0,0,0,H);
          g.addColorStop(0,'#fffaf6'); g.addColorStop(1,'#fff7f8');
          ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
        }
      }

      function handleJump(){
        if(!player.alive) return;
        const canGroundJump = player.onGround || player.coyoteTime > 0;
        if(canGroundJump && player.jumpBuffer > 0){
          player.vy = JUMP_V; player.onGround=false; player.hasJumpedOnce=true; player.jumpBuffer=0; player.coyoteTime=0;
          sfx.jump();
          if(currentLevel !== 0) statusEl.textContent = 'Salto ‚Äî suave.';
          return;
        }
        if(player.hasDouble && player.hasJumpedOnce && player.jumpBuffer > 0){
          player.vy = DOUBLE_V; player.hasJumpedOnce=false; player.jumpBuffer=0;
          sfx.double();
          statusEl.textContent = 'Doble salto activado üíñ';
        }
      }

      function update(){
        const lv = levels[currentLevel];

        // TROLL 1 & 7: Controles y Fricci√≥n
        const isReversed = !!lv.reversed;
        let friction = player.onGround ? FRICTION_GROUND : FRICTION_AIR;
        
        // Nivel 1 (index 0) es resbaloso
        if (currentLevel === 0 && player.onGround) {
            friction = 0.98; // Muy resbaloso
            if(Math.abs(player.vx) > 1 && player.alive) statusEl.textContent = '¬°Wiiii, resbala!';
        }
        
        if(isReversed) {
            if(keys.left) player.vx = Math.min(player.vx + ACCEL, MAX_VX);
            else if(keys.right) player.vx = Math.max(player.vx - ACCEL, -MAX_VX);
            else player.vx *= friction;
        } else {
            if(keys.left) player.vx = Math.max(player.vx - ACCEL, -MAX_VX);
            else if(keys.right) player.vx = Math.min(player.vx + ACCEL, MAX_VX);
            else player.vx *= friction;
        }


        // jump buffer + coyote timers
        if(keys.jump){ player.jumpBuffer = JUMP_BUFFER_MAX; keys.jump=false; }
        if(player.jumpBuffer > 0) player.jumpBuffer -= 1/60;
        if(player.coyoteTime > 0) player.coyoteTime -= 1/60;

        // F√≠sica
        player.vy += GRAV;
        player.x += player.vx;
        player.y += player.vy;

        // L√≠mites
        if(player.x < 0) player.x = 0;
        if(player.x + player.w > W) player.x = W - player.w;

        // Piso
        if(player.y + player.h > H){
          player.y = H - player.h; player.vy = 0; player.onGround = true; player.hasJumpedOnce=false; player.coyoteTime = COYOTE_MAX;
        } else {
          player.onGround = false;
        }
        
        // Actualizar part√≠culas
        updateParticles();

        // M√≥viles (velocidad limitada)
        if(lv.moving){
          for(const m of lv.moving){
            const spd = Math.min(m.spd || 0.8, 1.0);
            if(m.axis==='y'){
              m.y = (m.y ?? m.from) + spd * (m.dir || 1);
              if(m.y <= m.from){ m.y = m.from; m.dir = 1; }
              if(m.y >= m.to){ m.y = m.to; m.dir = -1; }
            } else {
              m.x = (m.x ?? m.from) + spd * (m.dir || 1);
              if(m.x <= m.from){ m.x = m.from; m.dir = 1; }
              if(m.x >= m.to){ m.x = m.to; m.dir = -1; }
            }
          }
        }

        // Colisi√≥n plataformas
        const plats = (lv.platforms||[]).concat(lv.moving||[]);
        for(const p of plats){
          const isFake = !!p.fake;
          const collX = player.x + player.w > p.x && player.x < p.x + p.w;
          const collY = player.y + player.h > p.y && player.y < p.y + p.h;
          if(collX && collY){
            const fromAbove = player.vy > 0 && (player.y + player.h - player.vy) <= p.y + 6;
            if(fromAbove){
              if(isFake && !p.invisible){ // Plataforma falsa Nivel 4
                p.y += 16; p.fake = false; // Se cae
                player.y = p.y - player.h; player.vy = 0; player.onGround = true; player.hasJumpedOnce=false; player.coyoteTime = COYOTE_MAX/2;
                statusEl.textContent = 'Ups, plataforma falsita ‚Äî igual te cuido.';
              } else {
                // Plataforma normal O invisible (Nivel 6)
                player.y = p.y - player.h; player.vy = 0; player.onGround = true; player.hasJumpedOnce=false; player.coyoteTime = COYOTE_MAX;
                if (p.invisible) p.invisible = false; // Se vuelve visible al tocarla
              }
            } else {
              if(player.x + player.w/2 < p.x + p.w/2) player.x = p.x - player.w;
              else player.x = p.x + p.w;
              player.vx = 0;
            }
          }
        }

        // Power-up doble salto
        if(levels[currentLevel].powerup && levels[currentLevel].powerup.active){
          const px = levels[currentLevel].powerup.x;
          const py = levels[currentLevel].powerup.y;
          const dx = (player.x + player.w/2) - px;
          const dy = (player.y + player.h/2) - py;
          if(Math.hypot(dx,dy) < 18){
            player.hasDouble = true; levels[currentLevel].powerup.active = false; powerLabel.textContent='‚úÖ Doble salto';
            sfx.power();
            emitParticles(px, py, 15, '#ff6b81'); // Part√≠culas de coraz√≥n
            flashMessage('Coraz√≥n doble salto activado üíñ');
          }
        }

        // Puzzles
        if(lv.type==='puzzle-switch'){
          for(const s of puzzle.switches){
            if(player.x + player.w > s.x && player.x < s.x + s.w && player.y + player.h > s.y && player.y < s.y + s.h){
              if(!s.active){ s.active = true; statusEl.textContent='Interruptor activado'; }
            }
          }
          if(puzzle.switches.length && puzzle.switches.every(sw=>sw.active)){
            for(const d of puzzle.doors) d.closed = false;
          }
          for(const d of puzzle.doors){
            if(d.closed){
              if(player.x + player.w > d.x && player.x < d.x + d.w && player.y + player.h > d.y && player.y < d.y + d.h){
                if(player.x < d.x) player.x = d.x - player.w; else player.x = d.x + d.w; player.vx = 0;
                statusEl.textContent = 'Puerta cerrada ‚Äî activa el interruptor.';
              }
            }
          }
        }

        if(lv.type==='puzzle-seq'){
          for(const p of puzzle.pads){
            if(player.x + player.w > p.x && player.x < p.x + p.w && player.y + player.h > p.y && player.y < p.y + p.h){
              if(!p.activated){
                const expectedOrder = puzzle.seq[puzzle.seqIndex];
                const padIndex = puzzle.pads.findIndex(pp=>pp.order===p.order);
                if(padIndex === expectedOrder){
                  p.activated = true; puzzle.seqIndex++;
                  statusEl.textContent = `Correcto (${puzzle.seqIndex}/${puzzle.seq.length})`;
                  if(puzzle.seqIndex >= puzzle.seq.length){
                    flashMessage('Secuencia completa ‚ú®');
                  }
                } else {
                  // TROLL 5: Secuencia incorrecta
                  puzzle.pads.forEach(pp=>pp.activated=false);
                  puzzle.seqIndex = 0;
                  statusEl.textContent = 'Orden incorrecto ‚Äî empieza otra vez (tranqui).';
                }
              }
            }
          }
        }

        // Spikes (hitbox)
        for(const s of (lv.spikes||[])){
            const spikeHit = (player.x + player.w > s.x + 4 && player.x < s.x + s.w - 4); // Hitbox X (para objetos √∫nicos)
            
            if(s.isFloor){
                // L√≥gica para pinchos de suelo (m√∫ltiples segmentos)
                const segments = Math.max(1, Math.floor(s.w/20));
                const step = s.w / segments;
                for(let i=0;i<segments;i++){
                    const sx = s.x + i*step;
                    const spikeTop = L-20 - 10; // Margen de perd√≥n de 10px
                    const overlapX = player.x + player.w > sx && player.x < sx + step;
                    const overlapY = player.y + player.h > spikeTop;
                    if(overlapX && overlapY){
                        sfx.hit();
                        tries++; triesLabel.textContent = tries;
                        levelTries[currentLevel]++; // Incrementar contador de muerte del nivel
                        emitAsh(player.x, player.y); // Efecto "Ash"
                        
                        // TROLL 3: Nivel 8 - Meta Oculta
                        if(currentLevel === 7 && levels[currentLevel].goal.hidden){
                          levels[currentLevel].goal.hidden = false;
                          flashMessage('¬°Apareci√≥ la meta! (Ten√≠as que morir ü§ç)', 2000);
                        }
                        
                        loadLevel(currentLevel);
                        statusEl.textContent = 'Te ca√≠ste ‚Äî tranqui, prueba otra vez.';
                        return;
                    }
                }
            } else if(s.isStarTroll) {
                // L√≥gica para Estrella Troll (Nivel 2)
                const spikeY = s.y - s.h; // Y del tope de la killzone
                const overlapY = player.y + player.h > spikeY && player.y < s.y; 
                if(spikeHit && overlapY){
                    sfx.hit();
                    tries++; triesLabel.textContent = tries;
                    levelTries[currentLevel]++; // Incrementar contador de muerte del nivel
                    emitAsh(player.x, player.y); // Efecto "Ash"
                    loadLevel(currentLevel);
                    flashMessage('¬°La estrella troll! ¬°Me mat√≥!');
                    return;
                }
            }
        }

        // Meta/Win condition check
        const goal = levels[currentLevel].goal;

        // TROLL 14: Win by Exit (right side of the screen)
        if (lv.exitWin && player.x + player.w >= W - 4) { // 4px margin
            sfx.ok();
            emitParticles(W - 20, H - 40, 15, '#ff6b81'); // Part√≠culas de coraz√≥n al ganar
            flashMessage(mensajes[currentLevel] || '¬°Lo hiciste! ‚ú®', 2600);
            nextLevel();
            return;
        }

        // Standard Goal Check (Star)
        if(goal && !goal.hidden && !goal.distraction) {
          const gx = goal.x;
          const gy = goal.y;
          const dd = Math.hypot((player.x+player.w/2)-gx, (player.y+player.h/2)-gy);
          if(dd < 20){
            sfx.ok();
            emitParticles(gx, gy, 15, '#ffd86b'); // Part√≠culas de estrella
            flashMessage(mensajes[currentLevel] || '¬°Lo hiciste! ‚ú®', 2600); // Duraci√≥n aumentada
            nextLevel();
            return;
          }
        }


        // Ejecuta salto si hay buffer activo
        handleJump();
      }

      function draw(){
        const lv = levels[currentLevel];
        ctx.clearRect(0,0,W,H);
        drawBG(lv);

        // Piso
        ctx.fillStyle = '#fff'; ctx.fillRect(0,H-60,W,60);

        // Plataformas
        const plats = (lv.platforms||[]).concat(lv.moving||[]);
        for(const p of plats){
          let fill = '#fff';
          let stroke = '#e6d4d6';

          if (p.fake) { // Nivel 4 (Falsa que cae)
              fill = '#fff8'; // Semi-transparente
              stroke = '#ffc0c0'; // Borde rosa
          }
          
          if (p.invisible) { // Nivel 6 y 9 (Invisible)
              fill = 'rgba(255, 255, 255, 0.05)'; // Casi invisible
              stroke = 'rgba(230, 212, 214, 0.1)'; // Borde casi invisible
          }

          rr(p.x,p.y,p.w,p.h,6, fill, stroke);
          
          // Punto negro indicador (SOLO Nivel 4, NO Nivel 6 o 9)
          if(p.fake && !p.invisible){ 
            ctx.fillStyle = '#382f2f'; // Punto negro
            ctx.beginPath();
            ctx.arc(p.x + p.w/2, p.y + p.h/2, 2, 0, Math.PI * 2);
            ctx.fill();
          }
        }
        
        // Dibujar Part√≠culas
        drawParticles();

        // Spikes
        for(const s of (lv.spikes||[])){
          if(s.isFloor){
            const segments = Math.max(1, Math.floor(s.w/20));
            for(let i=0;i<segments;i++){
              drawSpike(s.x + i*(s.w/segments), L-20, 20, 16);
            }
          } else if(s.isStarTroll) {
            // Dibujar como Estrella Troll
            drawStar(s.x + s.w/2, s.y - s.h/2, 12); 
          }
        }

        // Switches/puertas
        if(lv.type==='puzzle-switch'){
          for(const sw of puzzle.switches){
            rr(sw.x, sw.y, sw.w, sw.h, 4, sw.active ? '#ffd86b' : '#ddd', '#c8b0b4');
            ctx.fillStyle='#5b3336'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(sw.active?'ON':'OFF', sw.x+sw.w/2, sw.y+sw.h/2);
          }
          for(const d of puzzle.doors){
            if(d.closed) rr(d.x,d.y,d.w,d.h,6,'#8b5a5f','#6a3f42');
          }
        }

        // Pads
        if(lv.type==='puzzle-seq'){
          for(const p of puzzle.pads){
            rr(p.x,p.y,p.w,p.h,6, p.activated ? p.color : '#eee', '#cfcfcf');
            ctx.fillStyle = '#fff'; ctx.font='14px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText('‚óè', p.x + p.w/2, p.y + p.h/2);
          }
          ctx.fillStyle = '#5b3336'; ctx.font='13px system-ui';
          ctx.fillText(`Secuencia: ${puzzle.seqIndex}/${(puzzle.seq||[]).length}`, 10, 20);
        }

        // Power-up
        if(levels[currentLevel].powerup && levels[currentLevel].powerup.active){
          drawHeart(levels[currentLevel].powerup.x, levels[currentLevel].powerup.y, 10);
        }

        // Meta (TROLL 8 y DISTRACCI√ìN 14)
        if(levels[currentLevel].goal && !levels[currentLevel].goal.hidden) {
          drawStar(levels[currentLevel].goal.x, levels[currentLevel].goal.y, 10);
        }

        // Player
        if(player.alive) {
          rr(player.x, player.y, player.w, player.h, 6, '#fff', '#e6d4d6');
          ctx.font = '20px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillStyle = '#ff6b81'; ctx.fillText('ü§ç', player.x + player.w/2, player.y + player.h/2);
        }
      }

      /* --- CAMBIO 2: 'nextLevel' MODIFICADO CON POEMA --- */
      function nextLevel(){
        currentLevel++;
        if(currentLevel >= levels.length){
          // --- Poema A√±adido ---
          const poemaFinal = `Llegaste al final, mi vida. ü§ç

Pasaste el troll, pasaste el miedo.
Como en el juego, como en la vida,
eres la calma que siempre pido.

No hay m√°s niveles, solo nosotros.
Gracias por jugar, y gracias por quedarte.

Eres mi todo, hoy y siempre.
‚Äî Samuel`;
          
          // Usamos el modal de secretos para mostrar el poema
          showSecret(poemaFinal); 
          
          // Opcional: Cambiar el t√≠tulo del modal para que sea especial
          const modalTitle = document.querySelector('#secretModal h3');
          if (modalTitle) modalTitle.textContent = 'Un Poema Para Ti ‚ú®';
          // --- Fin de la adici√≥n ---

          setTimeout(()=>{ window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }, 500);
          currentLevel = 0;
          levelTries = {}; // Reiniciar contador de muertes al terminar
        } else {
          loadLevel(currentLevel);
        }
      }
      
      function dieAndReload() {
          sfx.hit();
          tries++; triesLabel.textContent = tries;
          if (!levelTries[currentLevel]) levelTries[currentLevel] = 0;
          levelTries[currentLevel]++; // Incrementar contador de muerte del nivel
          emitAsh(player.x, player.y); // Efecto "Ash"
          player.alive = false; // Detener al jugador

          // TROLL 8: Nivel 8 - Meta Oculta
          if(currentLevel === 7 && levels[currentLevel].goal.hidden){
            levels[currentLevel].goal.hidden = false;
            flashMessage('¬°Apareci√≥ la meta! (Ten√≠as que morir ü§ç)', 2000);
          }
          
          // Esperar un momento para ver las part√≠culas antes de recargar
          setTimeout(() => {
              loadLevel(currentLevel);
              statusEl.textContent = 'Te ca√≠ste ‚Äî tranqui, prueba otra vez.';
          }, 300); // 300ms de retraso
      }

      function loop(){ 
        if(player.alive) update(); 
        draw(); 
        requestAnimationFrame(loop); 
      }

      document.getElementById('restartBtn').addEventListener('click', ()=>{
        dieAndReload();
        statusEl.textContent = 'Reiniciado ‚Äî respira y dale otra vez.';
      });
      document.getElementById('nextBtn').addEventListener('click', ()=>{
        // TROLL: Bot√≥n que no funciona
        flashMessage('Primero toma la estrellita ‚ú®', 1200);
      });

      // Init
      loadLevel(0);
      loop();
    })();

    // Scroll inicial arriba
    setTimeout(()=>{ window.scrollTo({ top: 0 }); }, 80);
  });
</script>
</body>
</html>
